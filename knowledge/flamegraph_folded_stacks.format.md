# FlameGraph folded stacks

Простой текстовый формат для построения FlameGraph, хранения и обработки результатов профилирования.

Расширение файла: `.folded`.

Каждая запись в файле находится в отдельной строке и состоит из двух значений, разделенных пробелами.
* Строка без экранирования пробельных символов, представляющая стек вызовов. Состоит из одного или более имен фреймов, разделенных символом `;`. Каждый стек может присутствовать в файле только один раз. Любой префикс стека может иметь собственную запись.
* Неотрицательное целое число, представляющее количество семплов. Использование знака `+` перед числом не допускается.

### Рекомендации для записи

При записи значений в файл рекомендуется не использовать ведущие и замыкающие пробелы, а также использовать единственный пробел для разделения значений.
Файл не должен содержать повторяющихся стеков.
Файл не должен содержать пустых строк.
Файл должен заканчиваться переносом строки.

### Рекомендации для чтения

При чтении нужно учитывать возможность наличия ведущих и замыкающих пробельных символов, в том числе отличных от пробела. Значения могут быть разделены более чем одним пробельным символом.
Критически важно учитывать наличие пробелов в именах стек-фреймов.
Если конкретным приложением не предусмотрено иное, количество сэмплов для повторяющихся стеков должно суммироваться и далее обрабатываться как единая запись.

Во внутреннем представлении стек может храниться как строка, если приложению не требуется работать с отдельными частями, либо списком строк, полученных разделением строки стека по символу `;`.

Пример регулярного выражения:
```py
record_regex = r"\s*(.*)\s+(\d+)\s*"
```

Пример файла:
```
main         100
main;foo     10
main;bar baz 1
```

## Differential folded stacks

Расширение формата, добавляющее в каждую запись третье неотрицательное целое число, представляющее количество сэмплов для того же стека, полученное в другой сессии профилирования.
Если для одной из сессий стек отсутствует, то соответствующее число должно быть нулем.

Расширение файла: `.diff.folded`

Для разбора файла можно использовать такое регулярное выражение:
```py
diff_record_regex = r"\s*(.*)\s+(\d+)\s+(\d+)\s*"
```

Дифференциальный формат не имеет обобщений на большее число сессий.

## Источники
* https://github.com/brendangregg/FlameGraph
